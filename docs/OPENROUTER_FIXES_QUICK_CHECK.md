# Быстрая проверка исправлений OpenRouter

## Тестовые сценарии

### 1. Проверка дефолтного system prompt

**Запрос:**
```bash
POST /api/v1/chat/create
{
  "model_key": "qwen_coder",
  "title": "Тест языка"
  # system_prompt НЕ указан!
}
```

**Ожидаемый результат:** Чат создан с дефолтным prompt:
```json
{
  "model_settings": {
    "system_prompt": "Ты — полезный виртуальный помощник. ВАЖНО: ВСЕГДА отвечай ТОЛЬКО на русском языке..."
  }
}
```

### 2. Проверка языковой валидации

**Запрос:**
```bash
POST /api/v1/chat/{chat_id}/send
{
  "content": "как дела?"
}
```

**Если ответ содержит китайские символы:**

1. **Лог WARNING:**
   ```
   Обнаружен смешанный язык в ответе AI (CJK символы)
   ```

2. **Лог INFO:**
   ```
   Отправка повторного запроса с требованием русского языка
   ```

3. **Финальный ответ:** ТОЛЬКО русский текст

### 3. Проверка retry при rate limit

**Симуляция:** Отправить 10 запросов подряд

**Ожидаемые логи при 429:**
```
Отправка запроса к OpenRouter: model=... (попытка 1/3)
Rate limit [429]. Retry через 1 сек (попытка 1/3)
Отправка запроса к OpenRouter: model=... (попытка 2/3)
Rate limit [429]. Retry через 2 сек (попытка 2/3)
Отправка запроса к OpenRouter: model=... (попытка 3/3)
✨ Ответ получен успешно
```

### 4. Проверка ленивой инициализации

**Запрос к чату БЕЗ RAG:**
```bash
POST /api/v1/chat/{chat_id}/send
{
  "content": "простой вопрос без документов"
}
```

**Лог НЕ должен содержать:**
```
Инициализирован OpenRouter embeddings клиент  # ❌ НЕ должно быть!
```

**Лог ДОЛЖЕН содержать:**
```
Создание экземпляра RAGSearchService  # ✅ БЕЗ embeddings init
```

**Запрос с RAG (первый раз):**
```bash
POST /api/v1/chat/{chat_id}/send
{
  "content": "вопрос по документам"
}
```

**Теперь ДОЛЖНО появиться:**
```
Инициализирован OpenRouter embeddings клиент  # ✅ Только при первом RAG
```

## Возможные проблемы и решения

### Проблема: Всё ещё китайские символы

**Симптомы:**
- Логи показывают "Обнаружен смешанный язык"
- Correction запрос отправлен
- Но ответ всё равно содержит CJK

**Причина:** Модель упорно не следует инструкции

**Решение:**
1. Переключиться на другую модель (gemini_flash, deepseek_v3)
2. Увеличить строгость prompt в settings.py
3. Проверить, что OPENROUTER_DEFAULT_SYSTEM_PROMPT правильно применяется

### Проблема: Rate limit после всех retry

**Симптомы:**
- Логи: "Rate limit [429] превышен после 3 попыток"
- Пользователь получает ошибку

**Причина:** Реально превышен лимит бесплатной модели

**Решение:**
1. Проверить частоту запросов (не более 1-2 в секунду)
2. Добавить кэширование ответов (Redis)
3. Использовать платную модель или другую бесплатную

### Проблема: Медленные ответы

**Симптомы:**
- Ответы приходят через 5-10 секунд
- Логи показывают много correction запросов

**Причина:** Частое срабатывание языковой коррекции

**Решение:**
1. Использовать модель с лучшей поддержкой русского
2. Отключить auto-correction (использовать только cleaned_content)
3. Кэшировать похожие вопросы

## Быстрая диагностика через логи

```bash
# Фильтр логов для анализа
grep "Rate limit" logs/app.log | wc -l        # Количество 429 ошибок
grep "смешанный язык" logs/app.log | wc -l   # Количество языковых проблем
grep "Инициализирован OpenRouter" logs/app.log  # Проверка ленивой инициализации

# Проверка retry
grep "попытка" logs/app.log | tail -20

# Проверка correction запросов
grep "Отправка повторного запроса" logs/app.log | wc -l
```

## Метрики успешности

✅ **Исправление работает**, если:
- Rate limit 429: < 5% от общего числа запросов
- Смешанные языки: 0% в финальных ответах (после коррекции)
- OpenRouter init: только при первом RAG запросе, не при каждом request

❌ **Нужна дополнительная настройка**, если:
- Rate limit 429: > 20% запросов → переключиться на платную модель
- Смешанные языки: > 0% после коррекции → сменить модель или prompt
- OpenRouter init: в каждом request → проверить dependency injection
