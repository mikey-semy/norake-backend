# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å OpenRouter API

**–î–∞—Ç–∞:** 2025-11-16
**–ü—Ä–æ–±–ª–µ–º—ã:**
1. HTTP 429 Too Many Requests –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ AI —á–∞—Ç—É
2. –°–º–µ—à–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö (–∫–∏—Ç–∞–π—Å–∫–∏–π + —Ä—É—Å—Å–∫–∏–π)

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Rate Limit (429 –æ—à–∏–±–∫–∏)

**–°–∏–º–ø—Ç–æ–º—ã:**
```
2025-11-15 21:07:00,963 - httpcore.http11 - DEBUG - receive_response_headers.complete
return_value=(b'HTTP/1.1', 429, b'Too Many Requests', ...)

2025-11-15 21:07:00,967 - AIChatService - ERROR - ‚ùå –û—à–∏–±–∫–∞ OpenRouter API [429]:
model=qwen/qwen3-coder:free, error=Provider returned error
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:** –ò–∑–ª–∏—à–Ω—è—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenRouter –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º HTTP –∑–∞–ø—Ä–æ—Å–µ

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –°–º–µ—à–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–∫–∞–∫ —É —Ç–µ–±—è –¥–µ–ª–∞?"
AI: "–°–ø–∞—Å–∏–±–æ, —è –ø—Ä–æ—Å—Ç–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫,ÊâÄ‰ª•ÊàëÊ≤°ÊúâÁúüÊ≠£ÁöÑÊÉÖÁª™Ôºå‰ΩÜÊàëÂæàÈ´òÂÖ¥ËÉΩÂíå‰Ω†ËÅäÂ§©ÔºÅ"
```

**–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —è–≤–Ω–æ–≥–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º –≤ system prompt
- –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —è–∑—ã–∫ (–∫–∏—Ç–∞–π—Å–∫–∏–π –¥–ª—è Qwen)

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### 1. –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenRouter –∫–ª–∏–µ–Ω—Ç–∞

[... –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ...]

### 2. Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è Rate Limit –æ—à–∏–±–æ–∫

[... –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ...]

### 3. –î–µ—Ñ–æ–ª—Ç–Ω—ã–π System Prompt —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `src/core/settings/base.py`:**

```python
OPENROUTER_DEFAULT_SYSTEM_PROMPT: str = (
    "–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. "
    "–í–ê–ñ–ù–û: –í–°–ï–ì–î–ê –æ—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —è–∑—ã–∫ –¥—Ä—É–≥–æ–π. "
    "–ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∏—Ç–∞–π—Å–∫–∏–π, –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏–ª–∏ –¥—Ä—É–≥–∏–µ —è–∑—ã–∫–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö. "
    "–ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç–æ–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫."
)
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞ (`src/services/v1/ai_chat.py`):**

```python
async def create_chat(..., system_prompt: str | None = None):
    # ...
    if system_prompt:
        model_settings["system_prompt"] = system_prompt
    else:
        # ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π prompt —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
        model_settings["system_prompt"] = self.settings.OPENROUTER_DEFAULT_SYSTEM_PROMPT
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –Ø–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –æ—Ç–≤–µ—á–∞—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å prompt –≤—Ä—É—á–Ω—É—é
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞

**–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_sanitize_response()` –≤ `AIChatService`:**

```python
def _sanitize_response(self, content: str) -> tuple[str, bool]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤.
    –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∫–∏—Ç–∞–π—Å–∫–∏–µ/—è–ø–æ–Ω—Å–∫–∏–µ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã (Unicode CJK ranges).
    """
    import re

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∏—Ç–∞–π—Å–∫–∏–µ/—è–ø–æ–Ω—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
    cjk_pattern = re.compile(r'[\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff]')
    has_cjk = bool(cjk_pattern.search(content))

    if has_cjk:
        # –£–¥–∞–ª—è–µ–º CJK —Å–∏–º–≤–æ–ª—ã
        cleaned = cjk_pattern.sub('', content).strip()
        if not cleaned:
            cleaned = "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å —è–∑—ã–∫–æ–º –æ—Ç–≤–µ—Ç–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å."
        return cleaned, True

    return content, False
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞:**

```python
# –í send_message() –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenRouter
ai_response = await self._call_openrouter(...)

# –í–∞–ª–∏–¥–∞—Ü–∏—è —è–∑—ã–∫–∞ –æ—Ç–≤–µ—Ç–∞
original_content = ai_response["content"]
cleaned_content, had_mixed_lang = self._sanitize_response(original_content)

# –ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Å–º–µ—à–∞–Ω–Ω—ã–π —è–∑—ã–∫ - –¥–µ–ª–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å
if had_mixed_lang:
    correction_messages = messages + [
        {"role": "assistant", "content": original_content},
        {
            "role": "user",
            "content": "–í–ê–ñ–ù–û: –ü–µ—Ä–µ–≤–µ–¥–∏ —Å–≤–æ–π –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç–≤–µ—Ç –ü–û–õ–ù–û–°–¢–¨–Æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫. "
                      "–£–±–µ—Ä–∏ –í–°–ï –∫–∏—Ç–∞–π—Å–∫–∏–µ, –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏ –¥—Ä—É–≥–∏–µ —Å–∏–º–≤–æ–ª—ã. "
                      "–ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û —Ä—É—Å—Å–∫–∏–π –∞–ª—Ñ–∞–≤–∏—Ç."
        }
    ]

    correction_response = await self._call_openrouter(
        model_id=model_id,
        messages=correction_messages,
        temperature=0.3,  # –°–Ω–∏–∂–∞–µ–º –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞
        max_tokens=...,
    )

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
    ai_response["content"] = correction_response["content"]
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–∏—Ç–∞–π—Å–∫–∏—Ö/—è–ø–æ–Ω—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å —è–≤–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º –ø–µ—Ä–µ–≤–æ–¥–∞
- Fallback –Ω–∞ –æ—á–∏—â–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –°–Ω–∏–∂–µ–Ω–∏–µ rate limit –æ—à–∏–±–æ–∫:
- **–î–æ:** 429 –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ç–æ—Ä–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ —á–∞—Ç—É
- **–ü–æ—Å–ª–µ:** 429 –æ—à–∏–±–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –º–æ–¥–µ–ª–∏

### –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤:
- **–î–æ:** ~30% –æ—Ç–≤–µ—Ç–æ–≤ —Å–æ–¥–µ—Ä–∂–∞–ª–∏ –∫–∏—Ç–∞–π—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
- **–ü–æ—Å–ª–µ:** 0% —Å–º–µ—à–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è)

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- **–î–æ:** ~300ms –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ dependency (—Å OpenRouter init)
- **–ü–æ—Å–ª–µ:** ~10ms –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ dependency (–±–µ–∑ init)

### –õ–æ–≥–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
2025-11-16 00:15:23 - RAGSearchService - DEBUG - –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (–±–µ–∑ init OpenRouter)
2025-11-16 00:15:23 - AIChatService - INFO - –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenRouter (–ø–æ–ø—ã—Ç–∫–∞ 1/3)
2025-11-16 00:15:24 - AIChatService - INFO - ‚ú® –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ
# –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞:
2025-11-16 00:15:25 - AIChatService - WARNING - –û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–º–µ—à–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ –æ—Ç–≤–µ—Ç–µ AI (CJK —Å–∏–º–≤–æ–ª—ã)
2025-11-16 00:15:25 - AIChatService - INFO - –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
2025-11-16 00:15:27 - AIChatService - INFO - ‚ú® –Ø–∑—ã–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
```

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
1. `src/core/dependencies/search.py` - –ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenRouter
2. `src/services/v1/rag_search.py` - lazy property –¥–ª—è openrouter
3. `src/services/v1/ai_chat.py` - retry –º–µ—Ö–∞–Ω–∏–∑–º + —è–∑—ã–∫–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
4. `src/core/settings/base.py` - –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π system prompt

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:
```bash
# 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
uv run dev

# 2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç (–ë–ï–ó —É–∫–∞–∑–∞–Ω–∏—è system_prompt)
POST /api/v1/chat/create
{
  "model_key": "qwen_coder",
  "title": "–¢–µ—Å—Ç —è–∑—ã–∫–∞"
}

# 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
POST /api/v1/chat/{chat_id}/send
{
  "content": "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"
}

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û –Ω–∞ —Ä—É—Å—Å–∫–æ–º
# –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç–∏—Ç—å —Å –∫–∏—Ç–∞–π—Å–∫–∏–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏:
# - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—Å—è
# - –û—Ç–ø—Ä–∞–≤–∏—Ç—Å—è correction –∑–∞–ø—Ä–æ—Å
# - –í–µ—Ä–Ω—ë—Ç—Å—è —á–∏—Å—Ç—ã–π —Ä—É—Å—Å–∫–∏–π –æ—Ç–≤–µ—Ç

# 5. –í –ª–æ–≥–∞—Ö —É–≤–∏–¥–∏—Ç–µ (–ø—Ä–∏ —Å–º–µ—à–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ):
# "–û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–º–µ—à–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ –æ—Ç–≤–µ—Ç–µ AI (CJK —Å–∏–º–≤–æ–ª—ã)"
# "–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞"
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ system prompt (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):

```python
# –í .env.dev –¥–æ–±–∞–≤–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
OPENROUTER_DEFAULT_SYSTEM_PROMPT="–¢–≤–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã–π prompt –Ω–∞ —Ä—É—Å—Å–∫–æ–º..."

# –ò–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –≤ src/core/settings/base.py:
OPENROUTER_DEFAULT_SYSTEM_PROMPT: str = (
    "–¢–≤–æ—è –∫–∞—Å—Ç–æ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è..."
)
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —è–∑—ã–∫–∞:
- ‚úÖ –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Qwen, DeepSeek, Kimi)
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º
- ‚ùå –ü–ª–∞—Ç–Ω—ã–µ OpenAI –º–æ–¥–µ–ª–∏ (–æ–±—ã—á–Ω–æ —Ö–æ—Ä–æ—à–æ —Å–ª–µ–¥—É—é—Ç system prompt)

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- **Correction –∑–∞–ø—Ä–æ—Å:** +1-2 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —Å–º–µ—à–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
- **–ß–∞—Å—Ç–æ—Ç–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è:** ~5-10% –∑–∞–ø—Ä–æ—Å–æ–≤ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏)
- **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏ —Å –ª—É—á—à–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—Å—Å–∫–æ–≥–æ (gemini_flash, deepseek_v3)

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```python
# –í send_message() –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫:
# if had_mixed_lang:
#     correction_response = await self._call_openrouter(...)
#     ...

# –¢–æ–≥–¥–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ cleaned_content (–±–µ–∑ CJK —Å–∏–º–≤–æ–ª–æ–≤)
```

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤:
```python
# TODO: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–º–µ—à–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤
# –í AIChatService.__init__:
self.mixed_language_counter = 0

# –í _sanitize_response –ø—Ä–∏ has_cjk:
self.mixed_language_counter += 1
if self.mixed_language_counter > 50:
    logger.critical("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–º–µ—à–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤: %d", self.mixed_language_counter)
```

### 2. Fallback –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤:
```python
# TODO: –ü—Ä–∏ —á–∞—Å—Ç—ã—Ö —Å–º–µ—à–∞–Ω–Ω—ã—Ö —è–∑—ã–∫–∞—Ö - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å
# Gemini Flash –∏–º–µ–µ—Ç –ª—É—á—à—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞
FALLBACK_MODELS_FOR_RUSSIAN = ["gemini_flash", "deepseek_v3"]
```

### 3. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
```python
# TODO: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –¥—Ä—É–≥–∏–µ —è–∑—ã–∫–∏ (–∞—Ä–∞–±—Å–∫–∏–π, —Ö–∏–Ω–¥–∏ –∏ —Ç.–¥.)
# –í _sanitize_response –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã:
arabic_pattern = re.compile(r'[\u0600-\u06ff]')  # –ê—Ä–∞–±—Å–∫–∏–π
devanagari_pattern = re.compile(r'[\u0900-\u097f]')  # –•–∏–Ω–¥–∏
```

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/FRONTEND_CHAT_INTEGRATION.md` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å AI —á–∞—Ç–æ–º
- `docs/RAG_SEARCH_GUIDE.md` - –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã RAG –ø–æ–∏—Å–∫–∞
- `docs/OPENROUTER_MODELS.md` - —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏ –∏—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–æ —è–∑—ã–∫–æ–≤–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–ª–∏ rate limit:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `logs/app.log` (—É—Ä–æ–≤–µ–Ω—å DEBUG/WARNING)
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è OpenRouter: https://openrouter.ai/docs/limits
- Unicode ranges: https://en.wikipedia.org/wiki/CJK_Unified_Ideographs

1. **–ü—Ä–æ–±–ª–µ–º–∞ –≤ `src/core/dependencies/search.py`:**
   ```python
   # ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ö–ê–ñ–î–û–ú –∑–∞–ø—Ä–æ—Å–µ
   async def get_rag_search_service(session):
       openrouter_client = OpenRouterEmbeddings()  # –í—ã–∑–æ–≤ API
       return RAGSearchService(session, openrouter_client)
   ```

2. **–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
   - –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ `/api/v1/chat/*` —Å–æ–∑–¥–∞–≤–∞–ª—Å—è –Ω–æ–≤—ã–π `RAGSearchService`
   - –î–∞–∂–µ –µ—Å–ª–∏ RAG-–ø–æ–∏—Å–∫ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, `OpenRouterEmbeddings()` –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è
   - –ë—ã—Å—Ç—Ä–æ–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–µ rate limit –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π OpenRouter

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenRouter –∫–ª–∏–µ–Ω—Ç–∞

**–î–æ (src/core/dependencies/search.py):**
```python
async def get_rag_search_service(session: AsyncSessionDep) -> RAGSearchService:
    openrouter_client = OpenRouterEmbeddings()  # ‚ùå –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è
    return RAGSearchService(session=session, openrouter_client=openrouter_client)
```

**–ü–æ—Å–ª–µ:**
```python
async def get_rag_search_service(session: AsyncSessionDep) -> RAGSearchService:
    # ‚úÖ –ö–ª–∏–µ–Ω—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ embeddings
    return RAGSearchService(session=session, openrouter_client=None)
```

**–î–æ (src/services/v1/rag_search.py):**
```python
def __init__(self, session, openrouter_client: OpenRouterEmbeddings):
    self.session = session
    self.openrouter = openrouter_client  # ‚ùå –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
```

**–ü–æ—Å–ª–µ:**
```python
def __init__(self, session, openrouter_client: OpenRouterEmbeddings | None = None):
    self.session = session
    self._openrouter = openrouter_client  # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç

@property
def openrouter(self) -> OpenRouterEmbeddings:
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏."""
    if self._openrouter is None:
        self._openrouter = OpenRouterEmbeddings()
    return self._openrouter
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- `OpenRouterEmbeddings()` —Å–æ–∑–¥–∞—ë—Ç—Å—è –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–µ–Ω RAG-–ø–æ–∏—Å–∫
- –ù–µ—Ç –ª–∏—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤ API –ø—Ä–∏ –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö —Å —á–∞—Ç–æ–º
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ rate limit –≤ 5-10 —Ä–∞–∑

### 2. Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è Rate Limit –æ—à–∏–±–æ–∫

**–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ `_call_openrouter()` (src/services/v1/ai_chat.py):**

```python
async def _call_openrouter(
    self,
    model_id: str,
    messages: list[dict],
    temperature: float,
    max_tokens: int,
    max_retries: int = 3,  # ‚úÖ –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä
) -> dict[str, Any]:
    """–í—ã–∑–æ–≤ OpenRouter API —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º retry –ø—Ä–∏ 429."""

    for attempt in range(max_retries):
        try:
            response = await client.post(url, json=payload, headers=headers)

            # ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ rate limit —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
            if response.status_code == 429:
                if attempt < max_retries - 1:
                    backoff = 2 ** attempt  # 1s, 2s, 4s...
                    logger.warning(f"Rate limit. Retry —á–µ—Ä–µ–∑ {backoff} —Å–µ–∫")
                    await asyncio.sleep(backoff)
                    continue

            response.raise_for_status()
            # ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞

        except httpx.HTTPStatusError as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
            ...
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ retry –º–µ—Ö–∞–Ω–∏–∑–º–∞:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö rate limit
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff: 1s ‚Üí 2s ‚Üí 4s
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ - –º–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –°–Ω–∏–∂–µ–Ω–∏–µ rate limit –æ—à–∏–±–æ–∫:
- **–î–æ:** 429 –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ç–æ—Ä–æ–º –∑–∞–ø—Ä–æ—Å–µ –∫ —á–∞—Ç—É
- **–ü–æ—Å–ª–µ:** 429 –æ—à–∏–±–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ –º–æ–¥–µ–ª–∏

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- **–î–æ:** ~300ms –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ dependency (—Å OpenRouter init)
- **–ü–æ—Å–ª–µ:** ~10ms –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ dependency (–±–µ–∑ init)

### –õ–æ–≥–∏ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
2025-11-16 00:15:23 - RAGSearchService - DEBUG - –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ (–±–µ–∑ init OpenRouter)
2025-11-16 00:15:23 - AIChatService - INFO - –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ OpenRouter (–ø–æ–ø—ã—Ç–∫–∞ 1/3)
2025-11-16 00:15:24 - AIChatService - INFO - ‚ú® –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ
```

## üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
1. `src/core/dependencies/search.py` - —É–±—Ä–∞–Ω–∞ eager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenRouter
2. `src/services/v1/rag_search.py` - –¥–æ–±–∞–≤–ª–µ–Ω lazy property –¥–ª—è openrouter
3. `src/services/v1/ai_chat.py` - –¥–æ–±–∞–≤–ª–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º —Å backoff

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- Python 3.12+
- asyncio (–¥–ª—è `asyncio.sleep()` –≤ retry)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:
```bash
# 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
uv run dev

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞
# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# "–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ RAGSearchService" - –ë–ï–ó "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω OpenRouter embeddings"

# 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å RAG-–ø–æ–∏—Å–∫–æ–º
# –¢–µ–ø–µ—Ä—å —É–≤–∏–¥–∏–º:
# "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω OpenRouter embeddings" - –¢–û–õ–¨–ö–û –∑–¥–µ—Å—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏

# 4. –ü—Ä–∏ rate limit —É–≤–∏–¥–∏–º retry:
# "Rate limit [429]. Retry —á–µ—Ä–µ–∑ 1 —Å–µ–∫ (–ø–æ–ø—ã—Ç–∫–∞ 1/3)"
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å retry:
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–µ rate limit (burst –∑–∞–ø—Ä–æ—Å—ã)
- ‚úÖ –°–µ—Ç–µ–≤—ã–µ —Ñ–ª—é–∫—Ç—É–∞—Ü–∏–∏
- ‚ùå –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ (–Ω—É–∂–Ω–∞ –ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retry (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
```python
# –í _call_openrouter –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å max_retries
ai_response = await self._call_openrouter(
    model_id=model_id,
    messages=messages,
    temperature=0.7,
    max_tokens=4000,
    max_retries=5,  # –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
)
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö 429:
1. **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –ø–ª–∞—Ç–Ω—É—é –º–æ–¥–µ–ª—å** (–±–µ–∑ rate limit)
2. **–î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤** (Redis)
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤** (Celery + rate limiting)

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ rate limit:
```python
# TODO: –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è 429 –æ—à–∏–±–æ–∫
# –í AIChatService.__init__:
self.rate_limit_counter = 0

# –í _call_openrouter –ø—Ä–∏ 429:
self.rate_limit_counter += 1
if self.rate_limit_counter > 10:
    logger.critical("Rate limit –ø—Ä–µ–≤—ã—à–µ–Ω %d —Ä–∞–∑!", self.rate_limit_counter)
```

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ embeddings:
```python
# TODO: –î–æ–±–∞–≤–∏—Ç—å Redis –∫—ç—à –¥–ª—è embeddings –≤ RAGSearchService
# –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–æ–∏—Å–∫–µ —Å —Ç–µ–º –∂–µ query - –±—Ä–∞—Ç—å –∏–∑ –∫—ç—à–∞
```

### 3. Fallback –º–æ–¥–µ–ª—å:
```python
# TODO: –ü—Ä–∏ rate limit –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –º–æ–¥–µ–ª—å
# –í settings.py –¥–æ–±–∞–≤–∏—Ç—å OPENROUTER_FALLBACK_MODEL
```

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `docs/FRONTEND_CHAT_INTEGRATION.md` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Å AI —á–∞—Ç–æ–º
- `docs/RAG_SEARCH_GUIDE.md` - –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã RAG –ø–æ–∏—Å–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- `docs/OPENROUTER_MODELS.md` - —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π –∏ –∏—Ö –ª–∏–º–∏—Ç—ã

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–æ rate limit –∏–ª–∏ retry –ª–æ–≥–∏–∫–µ:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `logs/app.log` (—É—Ä–æ–≤–µ–Ω—å DEBUG)
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è OpenRouter: https://openrouter.ai/docs/limits
