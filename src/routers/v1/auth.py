"""
–†–æ—É—Ç–µ—Ä –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

–ú–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç HTTP API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π:
- –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É (login) –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π (admin/user)
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (refresh)
- –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã (logout)
- –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (me)

–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π exception handler.
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∏ Authorization, —Ç–∞–∫ –∏ cookies –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤.
"""

from typing import Optional

from fastapi import Cookie, Depends, Header, Query, Request, Response, status
from fastapi.security import OAuth2PasswordRequestForm

from src.routers.base import BaseRouter
from src.core.dependencies import AuthServiceDep
from src.core.security import CurrentUserDep
from src.schemas.v1.auth import (
    TokenResponseSchema,
    LogoutResponseSchema,
    CurrentUserResponseSchema,
)


class AuthRouter(BaseRouter):
    """
    –†–æ—É—Ç–µ—Ä –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç HTTP API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π:

    Public Endpoints:
        POST /auth/login - –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É (admin/user)
        POST /auth/refresh - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
        POST /auth/logout - –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        GET /auth/me - –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
        - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ–ª–µ–π: admin (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø) –∏ user (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
        - JWT —Ç–æ–∫–µ–Ω—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π refresh —Ç–æ–∫–µ–Ω–æ–≤
        - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ cookies
        - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Redis –¥–ª—è blacklist —Ç–æ–∫–µ–Ω–æ–≤
    """

    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç AuthRouter —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º –∏ —Ç–µ–≥–∞–º–∏."""
        super().__init__(prefix="auth", tags=["Authentication"])

    def configure(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ endpoint'–æ–≤ —Ä–æ—É—Ç–µ—Ä–∞."""

        # ==================== –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ====================

        @self.router.post(
            path="/login",
            response_model=TokenResponseSchema,
            status_code=status.HTTP_200_OK,
            description="""
            ## üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

            –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (admin –∏–ª–∏ user) –ø–æ email –∏ –ø–∞—Ä–æ–ª—é,
            –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API.

            ### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ä–æ–ª–∏:
            * **admin** - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∏—Å—Ç–µ–º—ã (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)
            * **user** - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø)

            ### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
            * **username**: Email –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            * **password**: –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            * **use_cookies**: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ cookies (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é False)

            ### Returns:
            * **access_token**: JWT —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ (—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 15 –º–∏–Ω—É—Ç)
            * **refresh_token**: Refresh —Ç–æ–∫–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 7 –¥–Ω–µ–π)
            * **token_type**: –¢–∏–ø —Ç–æ–∫–µ–Ω–∞ (Bearer)
            * **expires_in**: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ access —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

            ### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
            * –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ (is_active)
            * –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ bcrypt
            * Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞
            * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
            """,
            responses={
                200: {"description": "–£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"},
                401: {"description": "–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"},
                403: {"description": "–ê–∫–∫–∞—É–Ω—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"},
                429: {"description": "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤"},
            },
        )
        async def login(
            response: Response,
            form_data: OAuth2PasswordRequestForm = Depends(),
            use_cookies: bool = Query(
                False,
                description="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cookies –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤"
            ),
            auth_service: AuthServiceDep = None,
        ) -> TokenResponseSchema:
            """
            –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º JWT —Ç–æ–∫–µ–Ω–æ–≤.

            Args:
                response: –û—Ç–≤–µ—Ç FastAPI –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookies.
                form_data: –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (email, password).
                use_cookies: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ cookies –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤.
                auth_service: –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (dependency injection).

            Returns:
                TokenResponseSchema: –¢–æ–∫–µ–Ω—ã –¥–æ—Å—Ç—É–ø–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

            Raises:
                InvalidCredentialsError: –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                UserInactiveError: –ê–∫–∫–∞—É–Ω—Ç –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                RateLimitExceededError: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
            """
            return await auth_service.authenticate(
                form_data=form_data,
                response=response,
                use_cookies=use_cookies
            )

        # ==================== –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–û–ö–ï–ù–û–í ====================

        @self.router.post(
            path="/refresh",
            response_model=TokenResponseSchema,
            status_code=status.HTTP_200_OK,
            description="""
            ## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞

            –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ access —Ç–æ–∫–µ–Ω–∞ —Å –ø–æ–º–æ—â—å—é refresh —Ç–æ–∫–µ–Ω–∞.
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ access —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –Ω–æ refresh —Ç–æ–∫–µ–Ω –µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω.

            ### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ refresh —Ç–æ–∫–µ–Ω–∞:
            * **refresh-token** (–∑–∞–≥–æ–ª–æ–≤–æ–∫): –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫
            * **refresh_token** (cookie): –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

            ### Returns:
            * **access_token**: –ù–æ–≤—ã–π JWT —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞
            * **refresh_token**: –ù–æ–≤—ã–π refresh —Ç–æ–∫–µ–Ω (—Ä–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤)
            * **token_type**: –¢–∏–ø —Ç–æ–∫–µ–Ω–∞ (Bearer)
            * **expires_in**: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –Ω–æ–≤–æ–≥–æ access —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

            ### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
            * Refresh —Ç–æ–∫–µ–Ω—ã –∏–º–µ—é—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (7 –¥–Ω–µ–π)
            * –ü—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤—ã–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π refresh —Ç–æ–∫–µ–Ω
            * –°—Ç–∞—Ä—ã–π refresh —Ç–æ–∫–µ–Ω —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º (rotation)
            * –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            """,
            responses={
                200: {"description": "–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"},
                401: {"description": "–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"},
                419: {"description": "–¢–æ–∫–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω"},
                422: {"description": "–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω"},
                429: {"description": "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤"},
            },
        )
        async def refresh_token(
            request: Request,
            response: Response,
            use_cookies: bool = Query(
                False,
                description="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cookies –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤"
            ),
            refresh_token_header: Optional[str] = Header(
                None,
                alias="refresh-token",
                description="Refresh —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞"
            ),
            refresh_token_cookie: Optional[str] = Cookie(
                None,
                alias="refresh_token",
                description="Refresh —Ç–æ–∫–µ–Ω –∏–∑ cookie"
            ),
            auth_service: AuthServiceDep = None,
        ) -> TokenResponseSchema:
            """
            –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º refresh —Ç–æ–∫–µ–Ω–∞.

            Args:
                request: –ó–∞–ø—Ä–æ—Å FastAPI –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ cookies.
                response: –û—Ç–≤–µ—Ç FastAPI –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookies.
                use_cookies: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ cookies –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤.
                refresh_token_header: Refresh —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞.
                refresh_token_cookie: Refresh —Ç–æ–∫–µ–Ω –∏–∑ cookie.
                auth_service: –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (dependency injection).

            Returns:
                TokenResponseSchema: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã.

            Raises:
                TokenMissingError: –ï—Å–ª–∏ refresh —Ç–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                TokenExpiredError: –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                TokenInvalidError: –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                RateLimitExceededError: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
            """
            # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫ -> Cookie() –ø–∞—Ä–∞–º–µ—Ç—Ä -> request.cookies (fallback)
            refresh_token = (
                refresh_token_header 
                or refresh_token_cookie 
                or request.cookies.get("refresh_token")
            )

            return await auth_service.refresh_token(
                refresh_token=refresh_token,
                response=response,
                use_cookies=use_cookies
            )

        # ==================== –í–´–•–û–î ====================

        @self.router.post(
            path="/logout",
            response_model=LogoutResponseSchema,
            status_code=status.HTTP_200_OK,
            description="""
            ## üö™ –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã

            –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫.
            –ü–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏.

            ### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç–æ–∫–µ–Ω–∞:
            * **Authorization** (–∑–∞–≥–æ–ª–æ–≤–æ–∫): Bearer —Ç–æ–∫–µ–Ω –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏
            * **access_token** (cookie): –¢–æ–∫–µ–Ω –∏–∑ cookie –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

            ### Query Parameters:
            * **clear_cookies**: –û—á–∏—Å—Ç–∏—Ç—å –ª–∏ cookies –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é False)

            ### Returns:
            * **success**: –ë—É–ª–µ–≤–æ –∑–Ω–∞—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –≤—ã—Ö–æ–¥–∞
            * **message**: –°–æ–æ–±—â–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–º –≤—ã—Ö–æ–¥–µ
            * **data**: –û–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º logged_out_at (ISO 8601)

            ### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
            * –¢–æ–∫–µ–Ω—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ (blacklist)
            * –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è
            * –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞
            * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã—Ö–æ–¥–∞
            """,
            responses={
                200: {"description": "–£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"},
                401: {"description": "–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"},
                419: {"description": "–¢–æ–∫–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω"},
                422: {"description": "–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω"},
                429: {"description": "–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤"},
            },
        )
        async def logout(
            response: Response,
            clear_cookies: bool = Query(
                False,
                description="–û—á–∏—Å—Ç–∏—Ç—å cookies –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ"
            ),
            authorization: Optional[str] = Header(
                None,
                description="Bearer —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞"
            ),
            access_token_cookie: Optional[str] = Cookie(
                None,
                alias="access_token",
                description="Access —Ç–æ–∫–µ–Ω –∏–∑ cookie"
            ),
            auth_service: AuthServiceDep = None,
        ) -> LogoutResponseSchema:
            """
            –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤ –∏ –æ—á–∏—Å—Ç–∫–æ–π cookies.

            Args:
                response: –û—Ç–≤–µ—Ç FastAPI –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ cookies.
                clear_cookies: –û—á–∏—Å—Ç–∏—Ç—å –ª–∏ cookies –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ.
                authorization: Bearer —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞.
                access_token_cookie: Access —Ç–æ–∫–µ–Ω –∏–∑ cookie.
                auth_service: –°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (dependency injection).

            Returns:
                LogoutResponseSchema: –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—Ö–æ–¥–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π.

            Raises:
                TokenMissingError: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                TokenExpiredError: –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                TokenInvalidError: –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                RateLimitExceededError: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
            """
            # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫ -> cookie
            if not authorization and access_token_cookie:
                authorization = f"Bearer {access_token_cookie}"

            return await auth_service.logout(
                authorization=authorization,
                response=response,
                clear_cookies=clear_cookies
            )

        # ==================== –¢–ï–ö–£–©–ò–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ====================

        @self.router.get(
            path="/me",
            response_model=CurrentUserResponseSchema,
            status_code=status.HTTP_200_OK,
            description="""
            ## üë§ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

            **üîí –ó–∞—â–∏—â–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç** - —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–π access —Ç–æ–∫–µ–Ω.

            –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º –¥–ª—è:

            * **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ SPA
            * **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏** - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            * **–ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞** - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è UI —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            * **–í–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ç–æ–∫–µ–Ω –µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω

            ### –¢—Ä–µ–±—É–µ—Ç—Å—è:
            * –í–∞–ª–∏–¥–Ω—ã–π access —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization –∏–ª–∏ –≤ cookies
            * –¢–æ–∫–µ–Ω –ù–ï –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ blacklist (–ø–æ—Å–ª–µ logout)
            * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º–µ

            ### Returns:
            * **id**: UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            * **email**: Email –∞–¥—Ä–µ—Å
            * **username**: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            * **role**: –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (admin/user)
            * **is_active**: –°—Ç–∞—Ç—É—Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç–∞

            ### –¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
            ```javascript
            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/v1/auth/me', {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const user = await response.json();
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ store (Redux/Pinia/Zustand)
            ```
            """,
            responses={
                200: {"description": "–î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"},
                401: {"description": "–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω"},
                419: {"description": "–¢–æ–∫–µ–Ω –ø—Ä–æ—Å—Ä–æ—á–µ–Ω"},
                422: {"description": "–¢–æ–∫–µ–Ω –≤ blacklist –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"},
            },
        )
        async def get_current_user(
            current_user: CurrentUserDep = None,
        ) -> CurrentUserResponseSchema:
            """
            –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.

            üîí **–ó–∞—â–∏—â–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ CurrentUserDep.

            Args:
                current_user: –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ dependency injection (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞).

            Returns:
                CurrentUserResponseSchema: –î–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

            Raises:
                TokenMissingError: –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                TokenExpiredError: –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                TokenInvalidError: –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –≤ blacklist (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).
                InvalidCredentialsError: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ).

            Note:
                –≠—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CurrentUserDep, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
                - –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization –∏–ª–∏ cookies
                - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç JWT —Ç–æ–∫–µ–Ω
                - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
                - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –≤ blacklist
                - –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã —Å eager loading —Ä–æ–ª–µ–π
                - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ç–æ–≤—É—é —Å—Ö–µ–º—É UserCurrentSchema
            """
            # CurrentUserDep —É–∂–µ –≤–µ—Ä–Ω—É–ª –≤–∞–ª–∏–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
            # –ü—Ä–æ—Å—Ç–æ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ response schema
            return CurrentUserResponseSchema(
                success=True,
                message=None,
                data=current_user
            )
